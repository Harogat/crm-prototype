<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"><title>SEO-Abo ‚Äì Monatsrechnung</title>
  <script src="../shared/dataStorage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>body{font-family:Arial,sans-serif;margin:20px}.box{background:#f3f3f3;padding:10px;margin:10px 0}</style>
</head>
<body>
  <h1>üßæ SEO-Abo ‚Äì Monatsrechnung</h1>
  <button onclick="history.back()">‚Üê Zur√ºck</button>
  <div id="info" class="box"></div>
  <button id="create">Rechnung erzeugen</button>

  <script>
    const q=new URLSearchParams(location.search);
    const cid=q.get('cid'), sid=q.get('sid');
    const c = getCustomers().find(x=>x.id===cid);
    const s = (c?.subscriptions||[]).find(x=>x.id===sid);
    if(!c || !s){ alert("Kunde/Abo nicht gefunden."); location.href="../crm/customers.html"; }

    document.getElementById('info').innerText =
      `Kunde: ${c.firstName} ${c.lastName} ‚Ä¢ Abo: ${s.title} ‚Ä¢ Betrag: ${s.amount} ‚Ç¨ ‚Ä¢ f√§llig: ${s.nextDue}`;

    document.getElementById('create').onclick = ()=>{
      const res = createInvoiceFromSubscription(c.id, s.id, "Monatliche SEO-Leistung");
      const { invoice } = res;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("helvetica","bold"); doc.setFontSize(18);
      doc.text("RECHNUNG", 105, 20, {align:"center"});

      doc.setFont("helvetica","normal"); doc.setFontSize(11);
      doc.text(`Rechnungs-Nr.: ${invoice.number}`, 20, 35);
      doc.text(`Datum: ${new Date().toLocaleDateString("de-DE")}`, 20, 42);

      doc.setFont("helvetica","bold"); doc.text("Absender:", 20, 55);
      doc.setFont("helvetica","normal");
      doc.text("Dein Firmenname\nDeine Stra√üe 1\n12345 Dein Ort\ninfo@deinefirma.de", 20, 62);

      doc.setFont("helvetica","bold"); doc.text("Empf√§nger:", 120, 55);
      doc.setFont("helvetica","normal");
      doc.text(`${c.firstName} ${c.lastName}\n${c.email}`, 120, 62);

      doc.setFont("helvetica","bold"); doc.text("Leistung", 20, 95);
      doc.text("Betrag (‚Ç¨)", 170, 95, {align:"right"});
      doc.setFont("helvetica","normal");
      doc.text(`${s.title} ‚Äì ${invoice.title.split("‚Äì")[1]?.trim() || ""}`, 20, 105);
      doc.text(String(invoice.amount), 170, 105, {align:"right"});

      doc.setFont("helvetica","bold"); doc.text("Gesamt:", 20, 125);
      doc.text(String(invoice.amount)+" ‚Ç¨", 170, 125, {align:"right"});

      doc.setFont("helvetica","normal");
      doc.text("Zahlungsziel: 7 Tage. Vielen Dank!", 20, 145);

      doc.save(`Rechnung_${invoice.number}.pdf`);
      alert(`Abo-Rechnung erstellt: ${invoice.number}`);
      location.href="../crm/customers.html";
    };
  </script>
</body>
</html>